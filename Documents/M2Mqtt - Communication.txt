1.Create a new client (string broker host name,int broker port,bool secure, *)

MqttClient client = new uPLibrary.Networking.M2Mqtt.MqttClient("192.168.43.130", 1883, false, null, null, 0, null, null);

2. Add a run method to establish the connection with the borker.

public void run()
{
	2.1 Add a method to the client to handle the receive event
	client.MqttMsgPublishReceived += client_MqttMsgPublishReceived;
	2.2 Connect the client and subscribe it to a topic
	client.Connect(Guid.NewGuid().ToString());
	string topic = new string[] {"/topic1"};
	ushort msgId = client.Subscribe(topic, new byte[] { MqttMsgBase.QOS_LEVEL_EXACTLY_ONCE});
	client.ProtocolVersion = MqttProtocolVersion.Version_3_1_1;

}

3. Create the client_MqttMsgPublishReceived method

void client_MqttMsgPublishReceived(object sender, MqttMsgPublishEventArgs e)
        {
            Console.WriteLine(Encoding.UTF8.GetString(e.Message));
            //Temp,Humidity
            String s = Convert.ToString(Encoding.UTF8.GetString(e.Message));
            try
            {
                if (Encoding.UTF8.GetString(e.Message).Length > 7 && Encoding.UTF8.GetString(e.Message).Length < 100)
                {
                    string[] values = Encoding.UTF8.GetString(e.Message).Split(',');

                    sensor.RPiID = int.Parse(values[2]);
                    sensor.Date = DateTime.Now;
                    sensor.Temperature = float.Parse(values[0], CultureInfo.InvariantCulture.NumberFormat);
                    sensor.Humidity = float.Parse(values[1], CultureInfo.InvariantCulture.NumberFormat);
                    db.SensorDatas.Add(sensor);
                    db.SaveChanges();

                }
                else if (Encoding.UTF8.GetString(e.Message).Length <= 7)
                {
                    System.Diagnostics.Debug.WriteLine("Distance: " + Encoding.UTF8.GetString(e.Message));
                }
                else
                {
                    string[] values = Encoding.UTF8.GetString(e.Message).Split('@');
                    converter.convert(values[0]);
                    VisitorPhoto visitorPhoto = new VisitorPhoto();
                    string mac = values[1];
                    VisitorData visitorData = db2.VisitorDatas.SingleOrDefault(visitordata => visitordata.Mac == mac);
                    if (visitorData != null)
                    {
                        visitorPhoto.Mac = values[1];
                    }
                    else
                    {
                        visitorPhoto.Mac = "Unknown";
                    }
                    //Array.Copy(e.Message, x, values[0].Length);

                    byte[] x = { };

                    System.Diagnostics.Debug.WriteLine(e.Message[0]);
                    System.Diagnostics.Debug.WriteLine(e.Message[1]);
                    System.Diagnostics.Debug.WriteLine(e.Message[2]);
                    System.Diagnostics.Debug.WriteLine(e.Message[3]);

                    var sourceStartIndex = 0;
                    var destinationLength = values[0].Length - 10;
                    var destination = new byte[destinationLength];

                    Array.Copy(e.Message, sourceStartIndex, destination, 0, destinationLength);

                    visitorPhoto.Photo = destination;

                    visitorPhoto.Date = DateTime.Now;
                    System.Diagnostics.Debug.WriteLine(x);
                    db1.VisitorPhotoes.Add(visitorPhoto);
                    db1.SaveChanges();
                    System.Diagnostics.Debug.WriteLine("Image converted");

                    if (visitorPhoto.Mac != "Unknown")
                    {
                        ushort rgb_msgId = rgb_client.Publish("/rgb_led",
                            Encoding.UTF8.GetBytes("true"),
                            MqttMsgBase.QOS_LEVEL_EXACTLY_ONCE,//QoS level
                            true); //retained
                    }
                    else
                    {
                        ushort rgb_msgId = rgb_client.Publish("/rgb_led",
                            Encoding.UTF8.GetBytes("false"),
                            MqttMsgBase.QOS_LEVEL_EXACTLY_ONCE,//QoS level
                            true); //retained

                    }
                }


            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine("Connection closed\n");
                System.Diagnostics.Debug.WriteLine(ex);
                client.MqttMsgPublishReceived -= client_MqttMsgPublishReceived;
                client.Unsubscribe(new string[] { "sensors5" });
                client.Disconnect();

            }

        }


* - the rest of parameters are not relevant for our purpose so we keep the defaults